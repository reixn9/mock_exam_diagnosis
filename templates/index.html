<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>모의고사 진단지 생성기</title>
  <style>.hidden{display:none!important}</style>
</head>
<body>
<!-- VERSION: 2025-11-04-1 -->
<h1>모의고사 진단지 생성기</h1>

{% if error_messages %}
<div style="color:red;border:1px solid red;padding:10px;">
  <strong>입력 오류:</strong>
  <ul>{% for e in error_messages %}<li>{{ e }}</li>{% endfor %}</ul>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
  <input type="hidden" name="mode" id="modeInput" value="{{ last_mode or 'none' }}">

  <!-- STEP SELECT -->
  <div id="step-mode" {% if last_mode!='none' %}class="hidden"{% endif %}>
    <button type="button" onclick="selectMode('new')">새 파일 만들기</button>
    <button type="button" onclick="selectMode('add')">기존 파일에 학생 추가</button>
  </div>

  <!-- STEP NEW -->
  <div id="step-new" {% if last_mode!='new' %}class="hidden"{% endif %}>
    <h2>새 파일 만들기</h2>

    <label>학년</label>
    <select name="grade">
      {% set g = form_data.grade if form_data else '3' %}
      <option value="1" {{ 'selected' if g=='1' else '' }}>고1</option>
      <option value="2" {{ 'selected' if g=='2' else '' }}>고2</option>
      <option value="3" {{ 'selected' if g=='3' else '' }}>고3</option>
    </select><br>

    <label>년도</label>
    <input type="number" name="year" value="{{ form_data.year if form_data else 2025 }}"><br>
    <label>월</label>
    <input type="number" name="month" value="{{ form_data.month if form_data else 11 }}"><br>

    <label>레벨</label>
    <select name="level" id="levelSelect" onchange="toggleSchoolInput()">
      {% set lv = form_data.level if form_data else '실전' %}
      <option value="입문" {{ 'selected' if lv=='입문' else '' }}>입문</option>
      <option value="기본" {{ 'selected' if lv=='기본' else '' }}>기본</option>
      <option value="실전" {{ 'selected' if lv=='실전' else '' }}>실전</option>
      <option value="학교" {{ 'selected' if lv=='학교' else '' }}>학교</option>
    </select>
    <div id="schoolInput" {% if not form_data or form_data.level!='학교' %}class="hidden"{% endif %}>
      <input type="text" name="school_name" placeholder="학교명 입력" value="{{ form_data.school_name if form_data else '' }}">
    </div><br>

    <label>회차</label>
    <select name="round">
      {% set rd = form_data.round if form_data else '1' %}
      {% for i in range(1,13) %}
      <option value="{{ i }}" {{ 'selected' if rd==i|string else '' }}>{{ i }}</option>
      {% endfor %}
    </select><br>

    <label>카테고리 선택</label><br>
    <input type="checkbox" name="categories" value="공통" {% if '공통' in (form_data.getlist('categories') if form_data else []) %}checked{% endif %}>공통
    <input type="checkbox" name="categories" value="화작" {% if '화작' in (form_data.getlist('categories') if form_data else []) %}checked{% endif %}>화작
    <input type="checkbox" name="categories" value="언매" {% if '언매' in (form_data.getlist('categories') if form_data else []) %}checked{% endif %}>언매
    <br><br>

    <label>공통 정답</label>
    <textarea name="answers_공통">{{ form_data.answers_공통 if form_data else '' }}</textarea><br>
    <label>화작 정답</label>
    <textarea name="answers_화작">{{ form_data.answers_화작 if form_data else '' }}</textarea><br>
    <label>언매 정답</label>
    <textarea name="answers_언매">{{ form_data.answers_언매 if form_data else '' }}</textarea><br>

    <label>학생 수</label>
    <input type="number" name="new_student_count" value="{{ form_data.new_student_count if form_data else 0 }}"><br>
    <button type="submit">엑셀 만들기</button>
  </div>

  <!-- STEP ADD -->
  <div id="step-add" {% if last_mode!='add' %}class="hidden"{% endif %}>
    <h2>기존 파일에 학생 추가</h2>
    <input type="file" name="excel_file" accept=".xlsx"><br>
    <label>학생 수</label>
    <input type="number" name="add_student_count" value="{{ form_data.add_student_count if form_data else 0 }}"><br>
    <button type="submit">추가</button>
  </div>
</form>

<script>
function selectMode(m){
  document.getElementById('modeInput').value=m;
  document.getElementById('step-mode').classList.add('hidden');
  document.getElementById('step-new').classList.toggle('hidden', m!=='new');
  document.getElementById('step-add').classList.toggle('hidden', m!=='add');
}
function toggleSchoolInput(){
  const lv=document.getElementById('levelSelect').value;
  document.getElementById('schoolInput').classList.toggle('hidden', lv!=='학교');
}
</script>
</body>
</html>
