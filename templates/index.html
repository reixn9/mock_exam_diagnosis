<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëª¨ì˜ê³ ì‚¬ ì§„ë‹¨ì§€ ìƒì„±ê¸°</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>.hidden {display:none !important;}</style>
</head>
<body>
  <div class="page">
    <h1 class="title">ëª¨ì˜ê³ ì‚¬ ì§„ë‹¨ì§€ ìƒì„±ê¸°</h1>

    {% if error_messages %}
    <div class="alert alert-error">
      <strong>ì…ë ¥ ì˜¤ë¥˜ê°€ ìˆì–´ìš”.</strong>
      <ul>{% for e in error_messages %}<li>{{ e }}</li>{% endfor %}</ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="mainForm">
      <input type="hidden" name="mode" id="modeInput" value="{{ last_mode or 'none' }}">

      <!-- STEP 0 -->
      <div id="step-mode" class="card">
        <p class="subtitle">ë¬´ì—‡ì„ í• ê¹Œìš”?</p>
        <div class="mode-grid">
          <div class="mode-card" onclick="selectMode('new')">
            <h3>ğŸ“„ ìƒˆ íŒŒì¼ ë§Œë“¤ê¸°</h3><p>ì •ë‹µì„ ì…ë ¥í•˜ê³  ì—¬ëŸ¬ í•™ìƒì„ ë“±ë¡í•©ë‹ˆë‹¤.</p>
          </div>
          <div class="mode-card" onclick="selectMode('add')">
            <h3>â• ê¸°ì¡´ íŒŒì¼ì— í•™ìƒ ì¶”ê°€</h3><p>ê¸°ì¡´ ì—‘ì…€ì— í•™ìƒì„ ë”í•©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- STEP NEW -->
      <div id="step-new" class="card hidden">
        <h2>ìƒˆ íŒŒì¼ ë§Œë“¤ê¸°</h2>

        <div class="grid-2">
          <div>
            <label>í•™ë…„</label>
            <select name="grade">
              {% set g = (form_data.grade if form_data else '3') %}
              <option value="1" {{ 'selected' if g=='1' else '' }}>ê³ 1</option>
              <option value="2" {{ 'selected' if g=='2' else '' }}>ê³ 2</option>
              <option value="3" {{ 'selected' if g=='3' else '' }}>ê³ 3</option>
            </select>
          </div>
          <div>
            <label>ë…„ë„</label>
            <input type="number" name="year" value="{{ form_data.year if form_data else 2025 }}">
          </div>
          <div>
            <label>ì›”</label>
            <input type="number" name="month" value="{{ form_data.month if form_data else 11 }}">
          </div>
        </div>

        <div class="cat-box">
          <p class="small-title">ì¹´í…Œê³ ë¦¬ ì„ íƒ</p>
          <label class="chk"><input type="checkbox" name="categories" value="ê³µí†µ" id="cat-common"> ê³µí†µ</label>
          <label class="chk"><input type="checkbox" name="categories" value="í™”ì‘" id="cat-hwajak"> í™”ì‘</label>
          <label class="chk"><input type="checkbox" name="categories" value="ì–¸ë§¤" id="cat-eonmae"> ì–¸ë§¤</label>
        </div>

        <div class="answers-box" id="answers-common" style="display:none;">
          <label>ê³µí†µ ì •ë‹µ (1~45)</label>
          <textarea name="answers_ê³µí†µ" rows="3" placeholder="ì˜ˆ: 1 3 4 ... ë˜ëŠ” 15234 í˜•ì‹ ê°€ëŠ¥"></textarea>
        </div>
        <div class="answers-box" id="answers-hwajak" style="display:none;">
          <label>í™”ì‘ ì •ë‹µ (1~45)</label>
          <textarea name="answers_í™”ì‘" rows="3" placeholder="ì˜ˆ: 1 3 4 ... ë˜ëŠ” 15234 í˜•ì‹ ê°€ëŠ¥"></textarea>
        </div>
        <div class="answers-box" id="answers-eonmae" style="display:none;">
          <label>ì–¸ë§¤ ì •ë‹µ (1~45)</label>
          <textarea name="answers_ì–¸ë§¤" rows="3" placeholder="ì˜ˆ: 1 3 4 ... ë˜ëŠ” 15234 í˜•ì‹ ê°€ëŠ¥"></textarea>
        </div>

        <hr>
        <label>í•™ìƒ ìˆ˜</label>
        <select name="new_student_count" id="newStudentCount" onchange="buildStudentInputs('new')">
          <option value="0">0ëª…</option>
          {% for i in range(1,11) %}<option value="{{ i }}">{{ i }}ëª…</option>{% endfor %}
        </select>

        <div id="new-student-wrapper" class="students-wrapper"></div>
        <div class="actions">
          <button type="button" class="btn-secondary" onclick="backToMode()">ë’¤ë¡œ</button>
          <button type="submit" class="btn-primary">ì—‘ì…€ ë§Œë“¤ê¸°</button>
        </div>
      </div>

      <!-- STEP ADD -->
      <div id="step-add" class="card hidden">
        <h2>ê¸°ì¡´ íŒŒì¼ì— í•™ìƒ ì¶”ê°€</h2>
        <input type="file" name="excel_file" accept=".xlsx">
        <label>í•™ìƒ ìˆ˜</label>
        <select name="add_student_count" id="addStudentCount" onchange="buildStudentInputs('add')">
          <option value="0">0ëª…</option>
          {% for i in range(1,11) %}<option value="{{ i }}">{{ i }}ëª…</option>{% endfor %}
        </select>
        <div id="add-student-wrapper" class="students-wrapper"></div>
        <div class="actions">
          <button type="button" class="btn-secondary" onclick="backToMode()">ë’¤ë¡œ</button>
          <button type="submit" class="btn-primary">ì—‘ì…€ì— ì¶”ê°€</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ì´ˆê¸° ìƒíƒœ ìˆ¨ê¸°ê¸°
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("step-new").classList.add("hidden");
      document.getElementById("step-add").classList.add("hidden");

      // ì²´í¬ë°•ìŠ¤ ì—°ë™ ë¡œì§
      const c = document.getElementById("cat-common");
      const h = document.getElementById("cat-hwajak");
      const e = document.getElementById("cat-eonmae");

      const answersCommon = document.getElementById("answers-common");
      const answersH = document.getElementById("answers-hwajak");
      const answersE = document.getElementById("answers-eonmae");

      function updateVisibility(){
        answersCommon.style.display = c.checked ? "block" : "none";
        answersH.style.display = h.checked ? "block" : "none";
        answersE.style.display = e.checked ? "block" : "none";
      }

      // í™”ì‘/ì–¸ë§¤ëŠ” "ìŒìœ¼ë¡œ" ë™ì‘: í•˜ë‚˜ë¥¼ ì²´í¬/í•´ì œí•˜ë©´ ë‹¤ë¥¸ í•˜ë‚˜ë„ ë™ì¼í•˜ê²Œ
      h.addEventListener("change", () => {
        e.checked = h.checked;
        updateVisibility();
      });
      e.addEventListener("change", () => {
        h.checked = e.checked;
        updateVisibility();
      });
      c.addEventListener("change", updateVisibility);

      updateVisibility();
    });

    function selectMode(m){document.getElementById("modeInput").value=m;showStep(m);}
    function showStep(m){
      document.getElementById("step-mode").classList.add("hidden");
      document.getElementById("step-new").classList.toggle("hidden", m!=="new");
      document.getElementById("step-add").classList.toggle("hidden", m!=="add");
    }
    function backToMode(){
      document.getElementById("modeInput").value="none";
      document.getElementById("step-mode").classList.remove("hidden");
      document.getElementById("step-new").classList.add("hidden");
      document.getElementById("step-add").classList.add("hidden");
    }
    function buildStudentInputs(p){
      const c=parseInt(document.getElementById(p==="new"?"newStudentCount":"addStudentCount").value);
      const w=document.getElementById(p==="new"?"new-student-wrapper":"add-student-wrapper");
      w.innerHTML="";
      for(let i=1;i<=c;i++){
        w.innerHTML+=`
        <div class="student-box">
          <p class="student-title">${i}ë²ˆ í•™ìƒ</p>
          <label>ì´ë¦„</label>
          <input type="text" name="${p}_student_${i}_name" placeholder="ì˜ˆ: ê¹€ë¯¼ìˆ˜">
          <label>ì¹´í…Œê³ ë¦¬</label>
          <select name="${p}_student_${i}_category">
            <option value="ê³µí†µ">ê³µí†µ</option>
            <option value="í™”ì‘">í™”ì‘</option>
            <option value="ì–¸ë§¤">ì–¸ë§¤</option>
          </select>
          <label>ë‹µì•ˆ (1~45)</label>
          <textarea name="${p}_student_${i}_answers" rows="2" placeholder="1 2 3 4 5 ... ë˜ëŠ” 15234 í˜•ì‹ ê°€ëŠ¥"></textarea>
        </div>`;}
    }
  </script>
</body>
</html>
